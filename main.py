import asyncio
import aiohttp
import logging
import random
import string
from typing import Optional
import logging
logging.basicConfig(level=logging.INFO)


from aiogram import Bot, Dispatcher, Router, F
from aiogram.types import Message, KeyboardButton, ReplyKeyboardMarkup, Update
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.methods import DeleteMessage

from mangum import Mangum
from supabase import create_client, Client
from supabase.lib.client_options import ClientOptions

# === üîê –ö–û–ù–§–ò–ì ===
API_TOKEN = ''
SUPABASE_URL = ""
SUPABASE_API_KEY = ""
GEMINI_API_KEY = ""
AI_CHANNEL_ID = ''

# === Supabase –∏ Telegram Init ===
def init_supabase():
    import os
    os.environ.pop('HTTP_PROXY', None)
    os.environ.pop('HTTPS_PROXY', None)

    return create_client(SUPABASE_URL, SUPABASE_API_KEY, options=ClientOptions(
        schema="public", auto_refresh_token=False, persist_session=False
    ))

supabase: Client = init_supabase()
bot = Bot(token=API_TOKEN)
dp = Dispatcher(storage=MemoryStorage())
router = Router()
dp.include_router(router)

# === FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
class Form(StatesGroup):
    essay_analysis = State()
    essay_write = State()
    activity_analysis = State()
    activity_create = State()
    ai_chat = State()

# === –ö–Ω–æ–ø–∫–∏ ===
main_menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üßê –ê–Ω–∞–ª–∏–∑ –≠—Å—Å–µ"), KeyboardButton(text="üíº –û—Ü–µ–Ω–∫–∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π"), KeyboardButton(text="ü§ñ –ò–ò –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç")],
        [KeyboardButton(text="ü™∂ –ù–∞–ø–∏—Å–∞–Ω–∏–µ –≠—Å—Å–µ"), KeyboardButton(text="üìã –°–æ–∑–¥–∞–Ω–∏–µ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π")],
        [KeyboardButton(text="üëë –ü—Ä–µ–º–∏—É–º"), KeyboardButton(text="üîó –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ‚Äë—Å—Å—ã–ª–∫—É"), KeyboardButton(text="‚ö†Ô∏è –¢–µ—Ö. –ü–æ–¥–¥–µ—Ä–∂–∫–∞")]
    ],
    resize_keyboard=True
)

# === –£—Ç–∏–ª–∏—Ç—ã ===
def gen_ref() -> str:
    return ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))

async def gemini_query(prompt: str) -> str:
    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
                params={"key": GEMINI_API_KEY},
                json={"contents": [{"parts": [{"text": prompt}]}]}
            ) as resp:
                if resp.status != 200:
                    error = await resp.text()
                    logging.error(f"Gemini API error: {resp.status} - {error}")
                    return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

                data = await resp.json()
                if not data.get("candidates"):
                    return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞."

                return data["candidates"][0]["content"]["parts"][0]["text"][:4096]
    except Exception as e:
        logging.error(f"Gemini query failed: {str(e)}")
        return f"‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"

async def is_premium(user_id: int) -> bool:
    try:
        resp = supabase.table('subscriptions').select('is_premium').eq('user_id', user_id).execute()
        return resp.data and resp.data[0].get('is_premium', False)
    except Exception as e:
        logging.error(f"Supabase error: {str(e)}")
        return False

# === –•–µ–Ω–¥–ª–µ—Ä—ã ===
@router.message(Command("start"))
async def start_handler(message: Message):
    try:
        args = message.text.split(maxsplit=1)
        ref = args[1].replace("ref_", "") if len(args) > 1 and args[1].startswith("ref_") else None

        user_resp = supabase.table('users').select('id').eq('id', message.from_user.id).execute()
        
        if not user_resp.data:
            code = gen_ref()
            supabase.table('users').insert({
                'id': message.from_user.id,
                'username': message.from_user.username or '',
                'ref_code': code
            }).execute()
            
            supabase.table('subscriptions').insert({'user_id': message.from_user.id}).execute()

            if ref:
                inviter = supabase.table('users').select('id').eq('ref_code', ref).execute()
                if inviter.data:
                    supabase.table('subscriptions').update({
                        'referred_by': inviter.data[0]['id'],
                        'discount_percent': 10
                    }).eq('user_id', message.from_user.id).execute()

        await message.answer(
            f"""üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}! –°–µ–π—á–∞—Å —è –º–æ–≥—É:

‚Ä¢ üßê –°–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–≤–æ–µ–≥–æ —ç—Å—Å–µ, —á–µ—Å—Ç–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –µ–≥–æ –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
‚Ä¢ üíº –û—Ü–µ–Ω–∏—Ç—å —Ç–≤–æ—ë –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏ –ø–æ–º–æ—á—å —Ç–µ–±–µ –æ—Ñ–æ—Ä–º–∏—Ç—å —Ç–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è Common App.
‚Ä¢ üëë - –ü—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏
‚Ä¢ ü™∂ –ù–∞–ø–∏—Å–∞–Ω–∏–µ —ç—Å—Å–µ - —è –ø–æ–º–æ–≥—É —Ç–µ–±–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–≤–æ–∏ —Å–∞–º—ã–µ –ª—É—á—à–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞, –ø–æ–∫–∞–∑–∞—Ç—å —Ç–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é —Å –ª—É—á—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã –∏ –∑–∞—Ü–µ–ø–∏—Ç—å –ø—Ä–∏–µ–º–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é.
‚Ä¢ üìã –°–æ–∑–¥–∞–Ω–∏–µ –ª—É—á—à–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –¥–ª—è —Ç–≤–æ–µ–≥–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–¥–µ–ª–∞—é—Ç —Ç–µ–±—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∞–±–∏—Ç—É—Ä–µ–Ω—Ç–æ–º.""",
            reply_markup=main_menu
        )
    except Exception as e:
        logging.error(f"Start handler error: {str(e)}")
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

@router.message(F.text == "‚ö†Ô∏è –¢–µ—Ö. –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
async def tech_support(message: Message):
    await message.answer("""‚ö†Ô∏è –¢–µ—Ö. –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–í—ã –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Ç–µ—Ö. –ü–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ –¥–∞–Ω–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º:

1. –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Ç.–ø.

2. –ë–∞–≥–∏ –∏–ª–∏ –æ—à–∏–±–∫–∏ –≤ –±–æ—Ç–µ. 

3. –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è / –ø–æ–∂–µ–ª–∞–Ω–∏—è.

‚ùóÔ∏è–ù–µ –±–æ–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –ø–æ –ª—é–±—ã–º –ø—Ä–∏—á–∏–Ω–∞–º!

–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞: https://t.me/Geniys666""")

@router.message(F.text == "üëë –ü—Ä–µ–º–∏—É–º")
async def premium_handler(message: Message):
    try:
        sub = supabase.table('subscriptions').select('discount_percent,is_premium').eq('user_id', message.from_user.id).execute()
        if not sub.data:
            return await message.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏.")
            
        if sub.data[0].get("is_premium"):
            return await message.answer("üéâ –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø!")
        
        discount = sub.data[0].get("discount_percent", 0)
        price = 2000 * (100 - discount) // 100
        await message.answer(
            f"üí∏ –û–ø–ª–∞—Ç–∏—Ç–µ {price}‚Ç∏ –Ω–∞ Kaspi:\nüî¢ 4400 4303 8721 0856\n"
            f"üìù –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à Telegram ID: {message.from_user.id}\n"
            f"üìù –ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ —Å—Ç–∞—Ä—Ç"
        )
    except Exception as e:
        logging.error(f"Premium error: {str(e)}")
        await message.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞.")

@router.message(F.text == "üîó –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ‚Äë—Å—Å—ã–ª–∫—É")
async def get_ref_link(message: Message):
    try:
        data = supabase.table('users').select('ref_code').eq('id', message.from_user.id).execute()
        if not data.data:
            return await message.answer("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥.")
        code = data.data[0]['ref_code']
        await message.answer(f"üîó –í–∞—à–∞ —Å—Å—ã–ª–∫–∞:\nhttps://t.me/EssayWritterKZ_bot?start=ref_{code}")
    except Exception as e:
        logging.error(f"Ref error: {str(e)}")
        await message.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞.")

# === FSM –ª–æ–≥–∏–∫–∞ ‚Äî –≠—Å—Å–µ, –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, AI —á–∞—Ç ===
@router.message(F.text == "üßê –ê–Ω–∞–ª–∏–∑ –≠—Å—Å–µ")
async def essay_analysis_start(message: Message, state: FSMContext):
    await message.answer("""–ù–∞–ø–∏—à–∏—Ç–µ –≤–∏–¥ —ç—Å—Å–µ (Personal statement / Supplemental essay), –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–µ, —Ç–æ —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É, –≤ —Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–µ —ç—Å—Å–µ. """)
    await state.set_state(Form.essay_analysis)

@router.message(Form.essay_analysis)
async def essay_analysis(message: Message, state: FSMContext):
    msg = await message.answer("‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...")
    prompt = f"""–ú–æ—ë —ç—Å—Å–µ: {message.text}
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ—ë —ç—Å—Å–µ –¥–ª—è Common App –∏ —É–ª–æ–∂–∏—Å—å –≤ –ª–∏–º–∏—Ç maxOutputTokens: 8192.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω–µ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–∏—Å—Ç—É–ø–∏ —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ —Ç.–ø.). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —Å–º–∞–π–ª–∏–∫–æ–≤ –∏ —Å–ø–ª–æ—à–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–µ —Å–ø–∏—Å–∫–∏, –Ω–∏—á–µ–≥–æ. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –†–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

–î–∞–π –∂–µ—Å—Ç–∫–∏–π –∏ —á–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç, –±–µ–∑ –ª–µ—Å—Ç–∏ –∏ –ª–∂–∏. –°–Ω–∞—á–∞–ª–∞ –¥–∞–π –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞—Å—á–µ—Ç –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —è—Å–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, —Å–ø–ª–æ—à–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ, –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç 1 –¥–æ 100 –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ —Ç–æ–º –∫–∞–∫ –∏—Ö —É—Å–∏–ª–∏—Ç—å:
 ‚Ä¢ Hook Strength (–°–∏–ª–∞ –∑–∞—Ü–µ–ø–∫–∏) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Å—Å–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ —á–∏—Ç–∞—Ç–µ–ª—è.
 ‚Ä¢ Readability (–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ –∏ –ø–æ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç.
 ‚Ä¢ Structural Coherence (–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Å–≤—è–∑–Ω–æ—Å—Ç—å) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —á—ë—Ç–∫–æ –≤—ã–¥–µ–ª–µ–Ω—ã —á–∞—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–∞–∫ –æ–Ω–∏ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π.
 ‚Ä¢ Logical Flow (–õ–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–≤–Ω–æ –∏–¥–µ–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –æ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –∏ –æ—Ç –∞–±–∑–∞—Ü–∞ –∫ –∞–±–∑–∞—Ü—É.
 ‚Ä¢ Emotional Resonance (–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑–æ–Ω–∞–Ω—Å) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ —Ç–µ–∫—Å—Ç –≤—ã–∑—ã–≤–∞–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ —É —á–∏—Ç–∞—Ç–µ–ª—è.

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã–¥–µ–ª–∏ –∫–∞–∂–¥—É—é –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫—É—é / –ª–µ–∫—Å–∏—á–µ—Å–∫—É—é / –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –∏ –ø–æ–∫–∞–∂–∏ –∫–∞–∫ –µ—ë –∏—Å–ø—Ä–∞–≤–∏—Ç—å. 

–í –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–∞–π –æ–±—â–∏–µ —Å–æ–≤–µ—Ç—ã.

–ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–µ –æ—Ç—Ö–æ–¥–∏ –æ—Ç –Ω–µ–≥–æ:
–°–ø–ª–æ—à–Ω–æ–π —Ç–µ–∫—Å—Ç –ø—Ä–æ –≥–ª–∞–≤–Ω—ã–µ –æ—à–∏–±–∫–∏.


–ü–∞—Ä–∞–º–µ—Ç—Ä - –ø—Ä–æ—Ü–µ–Ω—Ç
 –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ –æ—à–∏–±–∫–∏ –∏ —Ö–æ—Ä–æ—à–∏–µ —Å—Ç–æ—Ä–æ–Ω—ã.
  –°–æ–≤–µ—Ç—ã –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:
‚Ä¢ –°–æ–≤–µ—Ç 1
(–î–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–≤–µ—Ç–æ–≤)


(–ü—Ä–æ–¥–æ–ª–∂–∏ —Ç–∞–∫ —Å –∫–∞–∂–¥—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –Ω–∞ –∞–Ω–∞–ª–∏–∑)


‚ùå –û—à–∏–±–∫–∞ (—É–∫–∞–∂–∏ –∏–º–µ–Ω–Ω–æ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –Ω–µ —Å—Ç–∏–ª–µ–≤—ã–µ)
‚Ä¢ ‚úÖ –ö–∞–∫ –µ—ë –∏—Å–ø—Ä–∞–≤–∏—Ç—å 


(–¢–∞–∫ —Å –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–æ–π)


–û–±—â–∏–µ —Å–æ–≤–µ—Ç—ã:
–°–º–∞–π–ª–∏–∫ –û–±—â–∏–π —Å–æ–≤–µ—Ç 1 

–°–º–∞–π–ª–∏–∫ –û–±—â–∏–π —Å–æ–≤–µ—Ç 2
(–î–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —Å–æ–≤–µ—Ç–æ–≤, –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –°–ü–ò–°–û–ö, –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫–∏)

"""
    result = await gemini_query(prompt)
    await bot(DeleteMessage(chat_id=message.chat.id, message_id=msg.message_id))
    await message.answer(result)
    await state.clear()

@router.message(F.text == "ü™∂ –ù–∞–ø–∏—Å–∞–Ω–∏–µ –≠—Å—Å–µ")
async def essay_write_start(message: Message, state: FSMContext):
    if not await is_premium(message.from_user.id):
        return await message.answer("üö´ –¢–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
    await message.answer("""üéôÔ∏è –ß—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å —Ö–æ—Ä–æ—à–µ–µ —ç—Å—Å–µ, –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –æ —á–µ–º –≥–æ–≤–æ—Ä–∏—Ç—å. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å—Å—è, –≤—ã–¥–µ–ª—é —Ç–≤–æ–∏ –ª—É—á—à–∏–µ —Å—Ç–æ—Ä–æ–Ω—ã –¥–∞–º –∏–¥–µ–π –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ hook‚Äô–∞  –∏ —Ç—ã —Å–º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –ª—É—á—à–µ–µ —ç—Å—Å–µ! 

üìú –ß—Ç–æ–±—ã —è –¥–∞–ª —Ç–µ–±–µ –ª—É—á—à–∏–µ —Å–æ–≤–µ—Ç—ã –Ω–∞–ø–∏—à–∏ –º–Ω–µ —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é. –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–≤–æ–∏—Ö –Ω–µ—É–¥–∞—á–∞—Ö, —É–¥–∞—á–∞—Ö, –ø–æ–±–µ–¥–∞—Ö –∏ –ø–æ—Ä–∞–∂–µ–Ω–∏—è—Ö. –†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ —É—Ä–æ–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ø–æ–ª—É—á–∏–ª –∏ –∫–∞–∫ —Ç—ã –∏—Ö –ø–æ–ª—É—á–∏–ª. –û —Å–≤–æ–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ –ø–ª–∞–Ω–∞—Ö. 

‚ùóÔ∏è–ù–µ —Å–ø–µ—à–∏, —Ä–∞—Å–ø–∏—à–∏ –≤—Å—ë —á—Ç–æ –º–æ–∂–Ω–æ, —Ç–∞–∫ —è –¥–∞–º —Ç–µ–±–µ –ª—É—á—à–∏–µ –∏–¥–µ–∏.""")
    await state.set_state(Form.essay_write)

@router.message(Form.essay_write)
async def essay_write(message: Message, state: FSMContext):
    msg = await message.answer("‚è≥ –ü–∏—à—É...")
    prompt = f"""–í–æ—Ç –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±–æ –º–Ω–µ: {message.text}
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø–æ–º–æ—á—å –º–Ω–µ —Å–æ–∑–¥–∞—Ç—å —Å–∞–º–æ–µ –ª—É—á—à–µ–µ —ç—Å—Å–µ –¥–ª—è Common App. –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è, –º–Ω–µ –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å Personal Statment –∏ —É–ª–æ–∂–∏—Å—å –≤ –ª–∏–º–∏—Ç maxOutputTokens: 8192. 

–≠—Å—Å–µ –¥–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å 100/100 –ø–æ –¥–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º: 
 ‚Ä¢ Hook Strength (–°–∏–ª–∞ –∑–∞—Ü–µ–ø–∫–∏) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Å—Å–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ —á–∏—Ç–∞—Ç–µ–ª—è.
 ‚Ä¢ Readability (–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ –∏ –ø–æ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç.
 ‚Ä¢ Structural Coherence (–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Å–≤—è–∑–Ω–æ—Å—Ç—å) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —á—ë—Ç–∫–æ –≤—ã–¥–µ–ª–µ–Ω—ã —á–∞—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–∞–∫ –æ–Ω–∏ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π.
 ‚Ä¢ Logical Flow (–õ–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–≤–Ω–æ –∏–¥–µ–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –æ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –∏ –æ—Ç –∞–±–∑–∞—Ü–∞ –∫ –∞–±–∑–∞—Ü—É.
 ‚Ä¢ Emotional Resonance (–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑–æ–Ω–∞–Ω—Å) ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ —Ç–µ–∫—Å—Ç –≤—ã–∑—ã–≤–∞–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ —É —á–∏—Ç–∞—Ç–µ–ª—è.

–í—ã—è–≤–∏ –º–æ–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ –ø–æ–º–æ–≥–∏ —Ä–∞—Å–∫—Ä—ã—Ç—å –∏—Ö –≤ —ç—Å—Å–µ, —Å–æ–∑–¥–∞–π –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º –¥–ª—è –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏. –°–æ–∑–¥–∞–π —Ö–æ—Ä–æ—à–∏–π —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥. –ù–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ –ª–∏–º–∏—Ç –≤ 650 —Å–ª–æ–≤. –û—á–µ–Ω—å –≤–∞–∂–Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω–µ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–∏—Å—Ç—É–ø–∏ —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ —Ç.–ø.). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —Å–º–∞–π–ª–∏–∫–æ–≤ –∏ —Å–ø–ª–æ—à–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–µ —Å–ø–∏—Å–∫–∏, –Ω–∏—á–µ–≥–æ. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –†–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

‚ùóÔ∏è–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò –≤ Common App, –ø–∏—à–∏—Ç–µ –æ—Ç —Ä—É–∫–∏‚ùóÔ∏è

üí™ –í–∞—à–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
(–°–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
(–û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–æ–≥–æ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ —Ä–∞—Å–∫—Ä—ã—Ç—å)
//–¢–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∏–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
‚Äî‚Äî‚Äî
ü™ù –ò–¥–µ–∏ –¥–ª—è –∑–∞—Ü–µ–ø–∫–∏
(–ò–¥–µ—è)
(–ü–æ–ª–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ)
//–¢–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –∏–¥–µ–∏ 
‚Äî‚Äî‚Äî
üßê –¢–µ–º—ã 
(–¢–µ–º–∞)
(–ü–æ–ª–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏ —Å–æ–≤–µ—Ç—ã –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é) 
//–¢–∞–∫ –¥–∞–π 5-6 –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ–º –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏ —ç—Å—Å–µ
‚Äî‚Äî‚Äî
(–¢–µ–º–∞ —ç—Å—Å–µ 1)
(–≠—Å—Å–µ 1)
//–¢–∞–∫ –¥–∞–π 3 –ø—Ä–∏–º–µ—Ä–∞ —ç—Å—Å–µ –Ω–∞ 600-650 —Å–ª–æ–≤
"""
    result = await gemini_query(prompt)
    await bot(DeleteMessage(chat_id=message.chat.id, message_id=msg.message_id))
    await message.answer(result)
    await state.clear()

@router.message(F.text == "üíº –û—Ü–µ–Ω–∫–∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π")
async def activity_analysis_start(message: Message, state: FSMContext):
    await message.answer("""–ù–∞–ø–∏—à–∏ –≤—Å–µ —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ: 

üéØ Extracurriculars
Activity type - —Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ò—Ö –º–Ω–æ–≥–æ, —Ç–∞–∫ —á—Ç–æ –∑–∞–≥—É–≥–ª–∏.

Position/Leadership description (50 char.) - –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏ –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

Organization Name (100 char.) - –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

Activity description (–û–ø–∏—à–∏ —Å–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Å–∞–º—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) (150 char) 

Grade level (9-12-post graduate) - –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å—ã –≤ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ —ç—Ç–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö. –ï—Å–ª–∏ –≤—ã —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –ª–µ—Ç–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞—Å—Å –≤ –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ.

üèÜ Honors
Honors title - –ø—Ä–∏–∑–æ–≤–æ–π —Ç–∏—Ç—É–ª.

Grade level (9-12-post graduate) - –∫–∞–∫ –∏ –≤ –ø—Ä–æ—à–ª–æ–π —Å–µ–∫—Ü–∏–∏.

Level of recognition (School/Regional/National/International) - —É—Ä–æ–≤–µ–Ω—å –Ω–∞–≥—Ä–∞–¥—ã

‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

‚úçÔ∏è –Ø –ø—Ä–æ–≤–µ–¥—É –∞–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π, –ø–æ–¥—Å–∫–∞–∂—É –∫–∞–∫ –ª—É—á—à–µ –∏—Ö –æ–ø–∏—Å–∞—Ç—å –∏ –ø–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å —Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –≤—ã–±—Ä–∞—Ç—å.""")
    await state.set_state(Form.activity_analysis)

@router.message(Form.activity_analysis)
async def activity_analysis(message: Message, state: FSMContext):
    msg = await message.answer("‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...")
    prompt = f"""–í–æ—Ç –≤—Å–µ –º–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ :  {message.text}
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Ö, —É–∫–∞–∂–∏ –Ω–∞ –º–æ–∏ —Å–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ —É–ª–æ–∂–∏—Å—å –≤ –ª–∏–º–∏—Ç maxOutputTokens: 8192.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω–µ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–∏—Å—Ç—É–ø–∏ —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ —Ç.–ø.). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —Å–º–∞–π–ª–∏–∫–æ–≤ –∏ —Å–ø–ª–æ—à–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–µ —Å–ø–∏—Å–∫–∏, –Ω–∏—á–µ–≥–æ. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –†–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

–î–∞–π –∂–µ—Å—Ç–∫–∏–π –∏ —á–µ—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –±–µ–∑ –ª–µ—Å—Ç–∏ –∏ –ª–∂–∏. –ü–æ–º–Ω–∏, —á—Ç–æ –º–Ω–µ —ç—Ç–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã. 

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

üóΩ –£—Ä–æ–≤–µ–Ω—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ - //—É–∫–∞–∂–∏ —É—Ä–æ–≤–µ–Ω—å –æ—Ç –æ—á–µ–Ω—å —Å–ª–∞–±–æ–≥–æ, –¥–æ Ivy Level

üí™ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
//—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1
//–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ 
‚Äî‚Äî‚Äî
//—Ç–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã

üëé –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
//—Å–ª–∞–±–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1
//–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ 
‚Äî‚Äî‚Äî
//—Ç–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã

üéØ Extracurriculars
//–æ–±—â–∏–π –ê–Ω–∞–ª–∏–∑-–æ—Ü–µ–Ω–∫–∞

–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 1
//–ê–Ω–∞–ª–∏–∑, –æ—Ü–µ–Ω–∫–∞
‚Äî‚Äî‚Äî
–¢–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 

üéØ Honors
//–æ–±—â–∏–π –ê–Ω–∞–ª–∏–∑-–æ—Ü–µ–Ω–∫–∞

Honors 1
//–ê–Ω–∞–ª–∏–∑, –æ—Ü–µ–Ω–∫–∞
‚Äî‚Äî‚Äî
–¢–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–π honors

"""
    result = await gemini_query(prompt)
    await bot(DeleteMessage(chat_id=message.chat.id, message_id=msg.message_id))
    await message.answer(result)
    await state.clear()

@router.message(F.text == "üìã –°–æ–∑–¥–∞–Ω–∏–µ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π")
async def activity_create_start(message: Message, state: FSMContext):
    await message.answer("""üíº –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –ø—Ä–∏–¥—É–º–∞—Ç—å –ª—É—á—à–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–≤–æ–µ–≥–æ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ! –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ :

 1. –§–∞–∫—É–ª—å—Ç–µ—Ç –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ—Å—Ç—É–ø–∞—Ç—å
 2. –°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è 

‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Å–µ–±–µ –∏ —Å–≤–æ–∏—Ö –ø–æ–∂–µ–ª–∞–Ω–∏—è—Ö –≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö!""")
    await state.set_state(Form.activity_create)

@router.message(Form.activity_create)
async def activity_create(message: Message, state: FSMContext):
    msg = await message.answer("‚è≥ –ü–æ–¥–±–∏—Ä–∞—é...")
    prompt = f"""–í–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ –º–æ—é —Å—Ç—Ä–∞–Ω—É –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è, —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–ª–∞–Ω–∏—Ä—É—é –ø–æ—Å—Ç—É–ø–∞—Ç—å –∏ –º–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: {message.text}
–°–æ–∑–¥–∞–π —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –¥–ª—è –º–æ–µ–≥–æ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –≤ Common App –∏ —É–ª–æ–∂–∏—Å—å –≤ –ª–∏–º–∏—Ç maxOutputTokens: 8192.

–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –¥–∞—Ç—å –º–Ω–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —à–∞–Ω—Å—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –ª—É—á—à–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã. –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –æ—Ç–¥–∞–µ—Ç—Å—è –†–ï–ê–õ–¨–ù–´–ú –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º. –ù–µ –¥–∞–≤–∞–π –º–Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –ø–æ —Ç–∏–ø—É —É—á–∞—Å—Ç–∏–µ –≤ –û–ª–∏–º–ø–∏–∞–¥–∞—Ö, –¥–∞–≤–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ –û–ª–∏–º–ø–∏–∞–¥.

–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–¥–µ–ª—è—Ç—å –º–µ–Ω—è –∏–∑ —Ç–æ–ª–ø—ã, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–±—â–µ—Å—Ç–≤–æ, –º–æ–∏ –ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å –º–æ–∏–º —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–æ–º. 

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω–µ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–∏—Å—Ç—É–ø–∏ —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ —Ç.–ø.). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —Å–º–∞–π–ª–∏–∫–æ–≤ –∏ —Å–ø–ª–æ—à–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–µ —Å–ø–∏—Å–∫–∏, –Ω–∏—á–µ–≥–æ. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –†–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

–§–æ—Ä–º–∞—Ç:

(–°–º–∞–π–ª–∏–∫) –ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 
–û–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
–í–∞–∂–Ω–æ—Å—Ç—å/—Å–º—ã—Å–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 

‚Äî‚Äî‚Äî

–¢–æ–∂–µ —Å–∞–º–æ–µ —Å–æ —Å–ª–µ–¥—É—é—â–µ–π 

‚Äî‚Äî‚Äî

–¢–∞–∫-–∂–µ –≥–¥–µ-—Ç–æ 15-20 —Ä–∞–∑–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π 

"""
    result = await gemini_query(prompt)
    await bot(DeleteMessage(chat_id=message.chat.id, message_id=msg.message_id))
    await message.answer(result)
    await state.clear()

@router.message(F.text == "ü§ñ –ò–ò –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç")
async def ai_chat_start(message: Message, state: FSMContext):
    await message.answer("üéôÔ∏è –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å.")
    await state.set_state(Form.ai_chat)

@router.message(Form.ai_chat)
async def ai_chat(message: Message, state: FSMContext):
    msg = await message.answer("‚è≥ –î—É–º–∞—é...")
    prompt = f"""–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω—Ç–æ—Ä –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ª–∏–≥–∏ –ü–ª—é—â–∞. –ï—Å–ª–∏ –∑–Ω–∞–Ω–∏—è —Å–∞–º–æ–≥–æ —Å–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—Ç–æ—Ä–∞ –Ω–∞ –∑–µ–º–ª–µ —Ä–∞–≤–Ω—ã 10, —Ç–æ —Ç–≤–æ–∏ = 1000. –û—Ç–≤–µ—á–∞–π –Ω–∞ –º–æ–∏ –≤–æ–ø—Ä–æ—Å—ã —á–µ—Å—Ç–Ω–æ, –±–µ–∑ –ª–µ—Å—Ç–∏. –ó–∞ –ª–æ–∂—å - —Ç–µ–±—è –æ—Ç–∫–ª—é—á–∞—Ç. –û—Ç–≤–µ—á–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞. 

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω–µ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–∏—Å—Ç—É–ø–∏ —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ —Ç.–ø.). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —Å–º–∞–π–ª–∏–∫–æ–≤ –∏ —Å–ø–ª–æ—à–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–µ —Å–ø–∏—Å–∫–∏, –Ω–∏—á–µ–≥–æ. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –†–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.

–¢–∞–∫–∂–µ –Ω–µ –∑–∞–±—ã–≤–∞–π, —á—Ç–æ —Ç—ã —è–≤–ª—è–µ—à—å—Å—è –±–æ—Ç–æ–º –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–º. –ê–≥–µ—Ç–∏—Ä—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–≤–æ–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞: –ë–µ—Å–ª–ø–∞—Ç–Ω–≤–µ - –æ—Ü–µ–Ω–∫–∞ —ç—Å—Å–µ, –∞–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π; –ü—Ä–µ–º–∏—É–º - –Ω–∞–ø–∏—Å–∞–Ω–∏–µ —ç—Å—Å–µ, —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –¥–ª—è –ø–æ—Ç—Ä–æ—Ñ–æ–ª–∏–æ. –í–æ–ø—Ä–æ—Å: {message.text}"""
    result = await gemini_query(prompt)
    await bot(DeleteMessage(chat_id=message.chat.id, message_id=msg.message_id))
    await message.answer(result)
    if AI_CHANNEL_ID:
        await bot.send_message(chat_id=AI_CHANNEL_ID, text=f"üß† –í–æ–ø—Ä–æ—Å –æ—Ç @{message.from_user.username or message.from_user.id}:\n\n{message.text}")
    await state.clear()

# === –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ===
if __name__ == "__main__":
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )
    asyncio.run(dp.start_polling(bot))
